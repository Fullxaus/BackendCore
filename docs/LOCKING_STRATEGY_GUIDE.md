# Руководство по выбору стратегии блокировок (Locking Strategy)

## Когда использовать Pessimistic Locking

**Используйте пессимистическую блокировку (`@Lock(PESSIMISTIC_WRITE)` / `findByIdForUpdate`), когда:**

- Операция **критична** и потеря обновления (lost update) недопустима.
- Конверсия Lead → Deal: только одна транзакция должна перевести лид в сделку; вторая должна дождаться и либо увидеть уже сконвертированный лид, либо получить ошибку.
- Вы готовы платить блокировкой строки/таблицы: вторая транзакция **ждёт** завершения первой.
- Конфликты по одной и той же сущности ожидаются **часто**, и повторные попытки (retry) нежелательны.

**Пример в проекте:** конверсия лида в сделку — метод `LeadRepository.findByIdForUpdate(leadId)` с `@Lock(PESSIMISTIC_WRITE)`. В логах SQL видно `SELECT ... FOR UPDATE`.

---

## Когда использовать Optimistic Locking

**Используйте оптимистическую блокировку (`@Version` на entity), когда:**

- Конфликты по одной записи **редки**, а чтений много.
- Допустимо при конфликте версий получить `OptimisticLockException` и повторить операцию или вернуть ошибку клиенту.
- Не хотите блокировать строки в БД: каждая транзакция читает, изменяет и пишет с проверкой версии; при расхождении версии — откат и retry/ошибка.
- Важна высокая пропускная способность при редких одновременных изменениях одной и той же сущности.

**Пример в проекте:** обычное обновление лида (статус, контакт и т.д.) через `LeadEntity` с полем `@Version`. При одновременном обновлении одна транзакция успешна, вторая получает `ObjectOptimisticLockingFailureException` — в сервисе конфликт логируется, можно повторить операцию или вернуть ошибку.

---

## Сравнение

| Критерий              | Pessimistic                    | Optimistic                |
|-----------------------|--------------------------------|---------------------------|
| Конфликты             | Вторая транзакция ждёт        | Вторая получает исключение |
| Производительность    | Блокировки, возможны очереди  | Нет блокировок чтения     |
| Retry                 | Обычно не нужен                | Часто нужен при конфликте |
| Типичное использование| Критичные операции (конверсия)| Массовые обновления, UI   |

---

## Рекомендации команды

1. **Конверсия Lead → Deal** — всегда через `findByIdForUpdate` (pessimistic), чтобы исключить двойную конверсию и lost update.
2. **Редактирование лида в UI** (статус, контакты) — optimistic locking с `@Version`; при конфликте — сообщение пользователю «данные изменились, обновите и повторите».
3. **Пакетные/фоновые обновления** по разным лидам — без явного lock; при обновлении одного и того же лида из двух задач — полагаться на `@Version` и обрабатывать `OptimisticLockException`.
